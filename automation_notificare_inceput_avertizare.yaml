alias: Notificare Meteo DetaliatÄƒ ANM
description: >-
  Trimite notificÄƒri pentru alerte meteo ANM cu Interval È™i Fenomene.
  FuncÈ›ioneazÄƒ cu orice judeÈ› selectat. VerificÄƒ validitatea senzorului sursÄƒ.
triggers:
  - trigger: state
    entity_id: 
      - sensor.mesaj_meteo_alba
      - sensor.mesaj_meteo_arad
      - sensor.mesaj_meteo_arges
      - sensor.mesaj_meteo_bacau
      - sensor.mesaj_meteo_bihor
      - sensor.mesaj_meteo_bistrita_nasaud
      - sensor.mesaj_meteo_botosani
      - sensor.mesaj_meteo_braila
      - sensor.mesaj_meteo_brasov
      - sensor.mesaj_meteo_bucuresti
      - sensor.mesaj_meteo_buzau
      - sensor.mesaj_meteo_calarasi
      - sensor.mesaj_meteo_caras_severin
      - sensor.mesaj_meteo_cluj
      - sensor.mesaj_meteo_constanta
      - sensor.mesaj_meteo_covasna
      - sensor.mesaj_meteo_dambovita
      - sensor.mesaj_meteo_dolj
      - sensor.mesaj_meteo_galati
      - sensor.mesaj_meteo_giurgiu
      - sensor.mesaj_meteo_gorj
      - sensor.mesaj_meteo_harghita
      - sensor.mesaj_meteo_hunedoara
      - sensor.mesaj_meteo_ialomita
      - sensor.mesaj_meteo_iasi
      - sensor.mesaj_meteo_ilfov
      - sensor.mesaj_meteo_maramures
      - sensor.mesaj_meteo_mehedinti
      - sensor.mesaj_meteo_mures
      - sensor.mesaj_meteo_neamt
      - sensor.mesaj_meteo_olt
      - sensor.mesaj_meteo_prahova
      - sensor.mesaj_meteo_salaj
      - sensor.mesaj_meteo_satu_mare
      - sensor.mesaj_meteo_sibiu
      - sensor.mesaj_meteo_suceava
      - sensor.mesaj_meteo_teleorman
      - sensor.mesaj_meteo_timis
      - sensor.mesaj_meteo_tulcea
      - sensor.mesaj_meteo_valcea
      - sensor.mesaj_meteo_vaslui
      - sensor.mesaj_meteo_vrancea

variables:
  cod_judet: "{{ trigger.entity_id.replace('sensor.mesaj_meteo_', '') }}"
  mesaj_complet: "{{ trigger.to_state.attributes.get('mesaj_complet', '') }}"

conditions:
  - condition: template
    value_template: >
      {{ states(trigger.entity_id) not in ['unavailable', 'unknown'] and 
         state_attr(trigger.entity_id, 'mesaj_complet') is not none }}

  - condition: template
    value_template: >
      {{ states('sensor.avertizari_meteo_anm') not in ['unavailable', 'unknown', 'None'] }}
  
  - condition: template
    value_template: |-
      {% if trigger.from_state is not none %}
        {% set old_state = trigger.from_state.state %}
        {% set old_msg = trigger.from_state.attributes.get('mesaj_complet', '') %}
        {% set new_msg = trigger.to_state.attributes.get('mesaj_complet', '') %}
        
        {% if old_state in ['unavailable', 'unknown'] %}
          false
        {% else %}
          {{ old_state != 'alerta' or old_msg != new_msg }}
        {% endif %}
      {% else %}
        false
      {% endif %}

actions:
  - action: homeassistant.update_entity
    target:
      entity_id: sensor.anm_avertizare_id

  - action: notify.mobile_app_iphone
    data:
      title: >
        {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower %}
          ğŸš¨ COD ROÈ˜U {{ cod_judet | upper }}
        {% elif 'portocaliu' in mesaj_complet | lower %}
          ğŸŸ  COD PORTOCALIU {{ cod_judet | upper }}
        {% elif 'galben' in mesaj_complet | lower %}
          âš ï¸ COD GALBEN {{ cod_judet | upper }}
        {% else %}
          â„¹ï¸ Informare Meteo {{ cod_judet | upper }}
        {% endif %}
      message: >
        {% set split_interval = mesaj_complet.split('Interval de valabilitate:') %}
        {% if split_interval | length > 1 %}
          {% set interval = split_interval[1].split('Fenomene')[0] | trim %}
        {% else %}
          {% set interval = "Vezi aplicaÈ›ia" %}
        {% endif %}

        {% set split_fenomene = mesaj_complet.split('Fenomene') %}
        {% if split_fenomene | length > 1 %}
          {% set raw_fen = split_fenomene[1].split('Zone')[0] | replace('vizate:', '') | replace('È™i zone vizate:', '') | trim %}
          {% set lista = raw_fen.split(',') %}
          {% set fenomene_formatat = namespace(out='') %}
          {% for item in lista %}
            {% set fenomene_formatat.out = fenomene_formatat.out + '\n- ' + item | trim %}
          {% endfor %}
          {% set fenomene_final = fenomene_formatat.out %}
        {% else %}
          {% set fenomene_final = " Vezi aplicaÈ›ia" %}
        {% endif %}

        ğŸ•’{{ interval }}

        ğŸ’¨ Fenomene vizate:{{ fenomene_final }}
      data:
        url: /dashboard-acasa/0
        push:
          sound:
            name: >
              {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower or 'portocaliu' in mesaj_complet | lower %}
                critical
              {% else %}
                default
              {% endif %}
            volume: 1

  - action: notify.html5
    data:
      title: >
        {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower %}
          ğŸš¨ COD ROÈ˜U {{ cod_judet | upper }}
        {% elif 'portocaliu' in mesaj_complet | lower %}
          ğŸŸ  COD PORTOCALIU {{ cod_judet | upper }}
        {% elif 'galben' in mesaj_complet | lower %}
          âš ï¸ COD GALBEN {{ cod_judet | upper }}
        {% else %}
          â„¹ï¸ Informare Meteo {{ cod_judet | upper }}
        {% endif %}
      message: >
        {% set split_interval = mesaj_complet.split('Interval de valabilitate:') %}
        {% if split_interval | length > 1 %}
          {% set interval = split_interval[1].split('Fenomene')[0] | trim %}
        {% else %}
          {% set interval = "Vezi aplicaÈ›ia" %}
        {% endif %}

        {% set split_fenomene = mesaj_complet.split('Fenomene') %}
        {% if split_fenomene | length > 1 %}
          {% set raw_fen = split_fenomene[1].split('Zone')[0] | replace('vizate:', '') | replace('È™i zone vizate:', '') | trim %}
          {% set lista = raw_fen.split(',') %}
          {% set fenomene_formatat = namespace(out='') %}
          {% for item in lista %}
            {% set fenomene_formatat.out = fenomene_formatat.out + '\n- ' + item | trim %}
          {% endfor %}
          {% set fenomene_final = fenomene_formatat.out %}
        {% else %}
          {% set fenomene_final = " Vezi aplicaÈ›ia" %}
        {% endif %}

        ğŸ•’{{ interval }}

        ğŸ’¨ Fenomene vizate:{{ fenomene_final }}
      data:
        tag: "alerta-meteo-{{ cod_judet }}"
        url: /dashboard-acasa/0

mode: parallel
max: 43
