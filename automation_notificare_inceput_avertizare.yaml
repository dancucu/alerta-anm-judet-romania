alias: Notificare Meteo DetaliatÄƒ ANM
description: >-
  Trimite notificÄƒri pentru alerte meteo ANM cu Interval È™i Fenomene.
  FuncÈ›ioneazÄƒ cu orice judeÈ› selectat. VerificÄƒ validitatea senzorului sursÄƒ.
triggers:
  - trigger: state
    entity_id: sensor.mesaj_meteo_alba
  - trigger: state
    entity_id: sensor.mesaj_meteo_arad
  - trigger: state
    entity_id: sensor.mesaj_meteo_arges
  - trigger: state
    entity_id: sensor.mesaj_meteo_bacau
  - trigger: state
    entity_id: sensor.mesaj_meteo_bihor
  - trigger: state
    entity_id: sensor.mesaj_meteo_bistrita_nasaud
  - trigger: state
    entity_id: sensor.mesaj_meteo_botosani
  - trigger: state
    entity_id: sensor.mesaj_meteo_braila
  - trigger: state
    entity_id: sensor.mesaj_meteo_brasov
  - trigger: state
    entity_id: sensor.mesaj_meteo_bucuresti
  - trigger: state
    entity_id: sensor.mesaj_meteo_buzau
  - trigger: state
    entity_id: sensor.mesaj_meteo_calarasi
  - trigger: state
    entity_id: sensor.mesaj_meteo_caras_severin
  - trigger: state
    entity_id: sensor.mesaj_meteo_cluj
  - trigger: state
    entity_id: sensor.mesaj_meteo_constanta
  - trigger: state
    entity_id: sensor.mesaj_meteo_covasna
  - trigger: state
    entity_id: sensor.mesaj_meteo_dambovita
  - trigger: state
    entity_id: sensor.mesaj_meteo_dolj
  - trigger: state
    entity_id: sensor.mesaj_meteo_galati
  - trigger: state
    entity_id: sensor.mesaj_meteo_giurgiu
  - trigger: state
    entity_id: sensor.mesaj_meteo_gorj
  - trigger: state
    entity_id: sensor.mesaj_meteo_harghita
  - trigger: state
    entity_id: sensor.mesaj_meteo_hunedoara
  - trigger: state
    entity_id: sensor.mesaj_meteo_ialomita
  - trigger: state
    entity_id: sensor.mesaj_meteo_iasi
  - trigger: state
    entity_id: sensor.mesaj_meteo_ilfov
  - trigger: state
    entity_id: sensor.mesaj_meteo_maramures
  - trigger: state
    entity_id: sensor.mesaj_meteo_mehedinti
  - trigger: state
    entity_id: sensor.mesaj_meteo_mures
  - trigger: state
    entity_id: sensor.mesaj_meteo_neamt
  - trigger: state
    entity_id: sensor.mesaj_meteo_olt
  - trigger: state
    entity_id: sensor.mesaj_meteo_prahova
  - trigger: state
    entity_id: sensor.mesaj_meteo_salaj
  - trigger: state
    entity_id: sensor.mesaj_meteo_satu_mare
  - trigger: state
    entity_id: sensor.mesaj_meteo_sibiu
  - trigger: state
    entity_id: sensor.mesaj_meteo_suceava
  - trigger: state
    entity_id: sensor.mesaj_meteo_teleorman
  - trigger: state
    entity_id: sensor.mesaj_meteo_timis
  - trigger: state
    entity_id: sensor.mesaj_meteo_tulcea
  - trigger: state
    entity_id: sensor.mesaj_meteo_valcea
  - trigger: state
    entity_id: sensor.mesaj_meteo_vaslui
  - trigger: state
    entity_id: sensor.mesaj_meteo_vrancea
conditions:
  # Verific cÄƒ entitatea triggeredÄƒ e pentru judeÈ›ul selectat (nu unavailable)
  - condition: template
    value_template: >
      {{ states(trigger.entity_id) not in ['unavailable', 'unknown'] and 
         state_attr(trigger.entity_id, 'mesaj_complet') is not none }}

  - condition: template
    value_template: >
      {{ states('sensor.avertizari_meteo_anm') not in ['unavailable', 'unknown',
      'None'] }}
  
  - condition: template
    value_template: |-
      {% if trigger.from_state is not none %}
        {% set old_state = trigger.from_state.state %}
        {% set old_msg = trigger.from_state.attributes.mesaj_complet | default('') %}
        {% set new_msg = trigger.to_state.attributes.mesaj_complet | default('') %}
        
        {% if old_state in ['unavailable', 'unknown'] %}
          false
        {% else %}
          {{ old_state != 'alerta' or old_msg != new_msg }}
        {% endif %}
      {% else %}
        false
      {% endif %}
    enabled: true
actions:
  # ActualizeazÄƒ senzorul de ID-uri pentru a fi sigur cÄƒ avem hÄƒrÈ›ile curente
  - action: homeassistant.update_entity
    target:
      entity_id: sensor.anm_avertizare_id

  # Notificare iPhone
  - action: notify.mobile_app_iphone
    data:
      title: >
        {%- set cod_judet = trigger.entity_id.replace('sensor.mesaj_meteo_', '') -%}
        {%- set mesaj_complet = state_attr(trigger.entity_id, 'mesaj_complet') | default('') -%}
        {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower %}
          ğŸš¨ COD ROÈ˜U {{ cod_judet | upper }}
        {% elif 'portocaliu' in mesaj_complet | lower %}
          ğŸŸ  COD PORTOCALIU {{ cod_judet | upper }}
        {% elif 'galben' in mesaj_complet | lower %}
          âš ï¸ COD GALBEN {{ cod_judet | upper }}
        {% else %}
          â„¹ï¸ Informare Meteo {{ cod_judet | upper }}
        {% endif %}
      message: >
        {%- set mesaj_complet = state_attr(trigger.entity_id, 'mesaj_complet') | default('') -%}
        
        {% set split_interval = mesaj_complet.split('Interval de valabilitate:') %}
        {% if split_interval | length > 1 %}
          {% set interval = split_interval[1].split('Fenomene')[0] | trim %}
        {% else %}
          {% set interval = "Vezi aplicaÈ›ia" %}
        {% endif %}

        {% set split_fenomene = mesaj_complet.split('Fenomene') %}
        {% if split_fenomene | length > 1 %}
          {% set raw_fen = split_fenomene[1].split('Zone')[0] | replace('vizate:', '') | replace('È™i zone vizate:', '') | trim %}
          {% set lista = raw_fen.split(',') %}
          {% set fenomene_formatat = namespace(out='') %}
          {% for item in lista %}
            {% set fenomene_formatat.out = fenomene_formatat.out + '\n- ' + item | trim %}
          {% endfor %}
          {% set fenomene_final = fenomene_formatat.out %}
        {% else %}
          {% set fenomene_final = " Vezi aplicaÈ›ia" %}
        {% endif %}

        ğŸ•’{{ interval }}

        ğŸ’¨ Fenomene vizate:{{ fenomene_final }}
      data:
        url: /dashboard-acasa/0
        push:
          sound:
            name: >
              {%- set mesaj_complet = state_attr(trigger.entity_id, 'mesaj_complet') | default('') -%}
              {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower or 'portocaliu' in mesaj_complet | lower %}
                critical
              {% else %}
                default
              {% endif %}
            volume: 1

  # Notificare HTML5 (browser desktop)
  - action: notify.html5
    data:
      title: >
        {%- set cod_judet = trigger.entity_id.replace('sensor.mesaj_meteo_', '') -%}
        {%- set mesaj_complet = state_attr(trigger.entity_id, 'mesaj_complet') | default('') -%}
        {% if 'rosu' in mesaj_complet | lower or 'roÈ™u' in mesaj_complet | lower %}
          ğŸš¨ COD ROÈ˜U {{ cod_judet | upper }}
        {% elif 'portocaliu' in mesaj_complet | lower %}
          ğŸŸ  COD PORTOCALIU {{ cod_judet | upper }}
        {% elif 'galben' in mesaj_complet | lower %}
          âš ï¸ COD GALBEN {{ cod_judet | upper }}
        {% else %}
          â„¹ï¸ Informare Meteo {{ cod_judet | upper }}
        {% endif %}
      message: >
        {%- set mesaj_complet = state_attr(trigger.entity_id, 'mesaj_complet') | default('') -%}
        
        {% set split_interval = mesaj_complet.split('Interval de valabilitate:') %}
        {% if split_interval | length > 1 %}
          {% set interval = split_interval[1].split('Fenomene')[0] | trim %}
        {% else %}
          {% set interval = "Vezi aplicaÈ›ia" %}
        {% endif %}

        {% set split_fenomene = mesaj_complet.split('Fenomene') %}
        {% if split_fenomene | length > 1 %}
          {% set raw_fen = split_fenomene[1].split('Zone')[0] | replace('vizate:', '') | replace('È™i zone vizate:', '') | trim %}
          {% set lista = raw_fen.split(',') %}
          {% set fenomene_formatat = namespace(out='') %}
          {% for item in lista %}
            {% set fenomene_formatat.out = fenomene_formatat.out + '\n- ' + item | trim %}
          {% endfor %}
          {% set fenomene_final = fenomene_formatat.out %}
        {% else %}
          {% set fenomene_final = " Vezi aplicaÈ›ia" %}
        {% endif %}

        ğŸ•’{{ interval }}

        ğŸ’¨ Fenomene vizate:{{ fenomene_final }}
      data:
        tag: "alerta-meteo-{{ trigger.entity_id.replace('sensor.mesaj_meteo_', '') }}"
        url: /dashboard-acasa/0

mode: parallel
max: 43
